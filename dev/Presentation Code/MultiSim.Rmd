
```{r}
library(GeneSPLS)
library(spls)
library(microbenchmark)
library(bench)

data("MultiSim") # load data
source(here::here("dev", "coef_valid.R"))
```


### CROSS-VALIDATION

```{r CV, warning = FALSE}
set.seed(815)


# Define candidate parameters
eta_candidates <- seq(0.95, 0.99, by = 0.01)
K_candidates <- 1:10

# spls

cv_multi_sim_R <- cv.spls(
  X_multi_sim,
  Y_multi_sim,
  fold = 5,
  eta = eta_candidates,
  K = K_candidates,
  kappa = 0.5,
  select = "pls2",
  fit = "widekernelpls",
  scale.x = TRUE,
  scale.y = FALSE,
  plot.it = FALSE)


# GeneSPLS

cv_multi_sim_Cpp <- cv_spls_cpp(
  X_multi_sim,
  Y_multi_sim,
  fold = 5,
  eta = eta_candidates,
  K = K_candidates,
  kappa = 0.5,
  select = "pls2",
  scale_x = TRUE,
  scale_y = FALSE,
  eps = 2e-3,
  maxstep = 10000,
  trace = FALSE)

eta_multi_sim_R <- cv_multi_sim_R$eta.opt
K_multi_sim_R <- cv_multi_sim_R$K.opt
eta_multi_sim_Cpp <- cv_multi_sim_Cpp$eta.opt
K_multi_sim_Cpp <- cv_multi_sim_Cpp$K.opt
rm(cv_multi_sim_R, cv_multi_sim_Cpp)
```


### SPLS MODEL FITTING

```{r SPLS, warning = FALSE}
set.seed(815)


# spls

spls_multi_sim_R <- spls(
  X_multi_sim,
  Y_multi_sim,
  K = K_multi_sim_Cpp,
  eta = eta_multi_sim_Cpp,
  fit = "widekernelpls")


# GeneSPLS

spls_multi_sim_Cpp <- spls_cpp(
  X_multi_sim,
  Y_multi_sim,
  K = K_multi_sim_Cpp,
  eta = eta_multi_sim_Cpp,
  kappa = 0.5,
  select = "pls2",
  fit = "widekernelpls",
  scale_x = TRUE,
  scale_y = FALSE,
  eps = 1e-4,
  maxstep = 100,
  trace = FALSE)

# Valid coefficients match
coef_valid(
  coef(spls_multi_sim_R),
  spls_multi_sim_Cpp$betahat,
  tolerance = 1e-6
)
```


### BENCHMARKING

```{r benchmarking, warning = FALSE}
set.seed(815)


### CV BENCHMARK ###

bench_cv_multi_sim <- microbenchmark(
  
  cv_multi_sim_R = cv.spls(
    X_multi_sim,
    Y_multi_sim,
    fold = 5,
    eta = eta_candidates,
    K = K_candidates,
    kappa = 0.5,
    select = "pls2",
    fit = "widekernelpls",
    scale.x = TRUE,
    scale.y = FALSE,
    plot.it = FALSE),
  
  cv_multi_sim_Cpp <- cv_spls_cpp(
    X_multi_sim,
    Y_multi_sim,
    fold = 5,
    eta = eta_candidates,
    K = K_candidates,
    kappa = 0.5,
    select = "pls2",
    scale_x = TRUE,
    scale_y = FALSE,
    eps = 2e-3,
    maxstep = 10000,
    trace = FALSE),
  
  times = 1
)


### MODEL BENCHMARK ###

bench_spls_multi_sim <- microbenchmark(
  
  spls_multi_sim_R = spls(
    X_multi_sim,
    Y_multi_sim,
    K = K_multi_sim_Cpp,
    eta = eta_multi_sim_Cpp,
    fit = "widekernelpls"),
  
  spls_multi_sim_Cpp = spls_cpp(
    X_multi_sim,
    Y_multi_sim,
    K = K_multi_sim_Cpp,
    eta = eta_multi_sim_Cpp,
    kappa = 0.5,
    select = "pls2",
    fit = "widekernelpls",
    scale_x = TRUE,
    scale_y = FALSE,
    eps = 1e-4,
    maxstep = 100,
    trace = FALSE),
  
  times = 50
)
```

```{r benchmark results}
print(bench_cv_multi_sim) # CV benchmark results
print(bench_spls_multi_sim) # SPLS benchmark results
```

```{r benchmark2}
result = bench::mark(
  spls_multi_sim_R = spls(
    X_multi_sim,
    Y_multi_sim,
    K = K_multi_sim_Cpp,
    eta = eta_multi_sim_Cpp,
    fit = "widekernelpls"),
  
  spls_multi_sim_Cpp = spls_cpp(
    X_multi_sim,
    Y_multi_sim,
    K = K_multi_sim_Cpp,
    eta = eta_multi_sim_Cpp,
    kappa = 0.5,
    select = "pls2",
    fit = "widekernelpls",
    scale_x = TRUE,
    scale_y = FALSE,
    eps = 1e-4,
    maxstep = 100,
    trace = FALSE),
  check = F,
  iterations = 20
)

print(result)
```
